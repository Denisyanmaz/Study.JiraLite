@page "{id:guid}"
@model JiraLite.Web.Pages.Tasks.DetailsModel
@using JiraLite.Domain.Enums

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <div class="text-muted small">
            <a href="/Projects">Projects</a> / Task
        </div>
        <h2 class="mb-0">@Model.Task?.Title</h2>
        <div class="text-muted">TaskId: <code>@Model.Id</code></div>
    </div>

    <div class="d-flex gap-2">
        @if (Model.Task != null)
        {
            <a class="btn btn-outline-secondary" href="/Projects/Details/@Model.Task.ProjectId">Back to Project</a>
        }
    </div>
</div>

@if (!string.IsNullOrWhiteSpace(Model.Error))
{
    <div class="alert alert-danger" style="white-space:pre-wrap;">@Model.Error</div>
}
else
{
    <ul class="nav nav-tabs mb-3">
        <li class="nav-item">
            <a class="nav-link @(Model.Tab == "overview" ? "active" : "")"
               href="/Tasks/Details/@Model.Id?tab=overview">Overview</a>
        </li>
        <li class="nav-item">
            <a class="nav-link @(Model.Tab == "comments" ? "active" : "")"
               href="/Tasks/Details/@Model.Id?tab=comments">Comments</a>
        </li>
        <li class="nav-item">
            <a class="nav-link @(Model.Tab == "activity" ? "active" : "")"
               href="/Tasks/Details/@Model.Id?tab=activity">Activity</a>
        </li>
    </ul>

    @* ---------------- Overview ---------------- *@
    @if (Model.Tab == "overview")
    {
        <div class="card">
            <div class="card-body">

                <div class="d-flex justify-content-between align-items-start gap-3 flex-wrap">
                    <div class="flex-grow-1">
                        <label class="text-muted small mb-1">Title</label>
                        <input id="title" class="form-control" value="@Model.Task?.Title" />
                    </div>
                </div>

                <div class="mt-3">
                    <label class="text-muted small mb-1">Description</label>
                    <textarea id="description" class="form-control" rows="4">@Model.Task?.Description</textarea>
                </div>

                <hr />

                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="text-muted small mb-1">Status</label>
                        <select id="status" class="form-select" onchange="saveStatus()">
                            @foreach (var s in Enum.GetValues<JiraTaskStatus>())
                            {
                                <option value="@s" selected="@(Model.Task?.Status == s)">@s</option>
                            }
                        </select>
                        <div class="form-text">Auto-saves on change</div>
                    </div>

                    <div class="col-md-4">
                        <label class="text-muted small mb-1">Priority</label>
                        <select id="priority" class="form-select">
                            @for (var p = 1; p <= 5; p++)
                            {
                                var label = p switch
                                {
                                    1 => "High",
                                    2 => "Medium-High",
                                    3 => "Medium",
                                    4 => "Medium-Low",
                                    5 => "Low",
                                    _ => ""
                                };

                                <option value="@p" selected="@(Model.Task?.Priority == p)">
                                    @p (@label)
                                </option>
                            }
                        </select>

                    </div>

                    <div class="col-md-4">
                        <label class="text-muted small mb-1">Due Date</label>
                        <input id="dueDate" type="date" class="form-control"
                               value="@(Model.Task?.DueDate?.ToString("yyyy-MM-dd") ?? "")" />
                        <div class="form-text">Sends yyyy-MM-dd (safe for Postgres)</div>
                    </div>
                </div>

                <div class="row g-3 mt-1">
                    <div class="col-md-6">
                        <label class="text-muted small mb-1">Assignee</label>
                        <select id="assigneeId"
                                class="form-select"
                                asp-for="Task.AssigneeId"
                                asp-items="Model.AssigneeSelectItems">
                        </select>
                    </div>

                    <div class="col-md-6 d-flex align-items-end justify-content-end gap-2">
                        <button id="btnSaveAll" class="btn btn-primary" type="button" onclick="saveFullUpdate()">
                            Save changes
                        </button>
                        <button class="btn btn-outline-secondary" type="button" onclick="resetToServerValues()">
                            Reset
                        </button>
                    </div>
                </div>

                <hr />

                <div class="small text-muted">
                    ProjectId: <code>@Model.Task?.ProjectId</code>
                </div>

                <div id="toast" class="alert d-none mt-3 mb-0" role="alert"></div>
            </div>
        </div>

        <script>
            // Server values for reset (keeps UI simple)
            const serverTask = {
                id: "@Model.Id",
                projectId: "@Model.Task?.ProjectId",
                title: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Task?.Title ?? "")),
                description: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Task?.Description ?? "")),
                status: "@Model.Task?.Status",
                priority: "@(Model.Task?.Priority ?? 3)",
                assigneeId: "@Model.Task?.AssigneeId",
                dueDate: "@(Model.Task?.DueDate?.ToString("yyyy-MM-dd") ?? "")"
            };

            function showToast(message, ok = true) {
                const el = document.getElementById("toast");
                el.classList.remove("d-none", "alert-success", "alert-danger");
                el.classList.add(ok ? "alert-success" : "alert-danger");
                el.innerText = message;
                setTimeout(() => el.classList.add("d-none"), 2500);
            }

            function setSaving(isSaving) {
              const btn = document.getElementById("btnSaveAll");
              if (btn) btn.disabled = isSaving;
            }

            function resetToServerValues() {
                document.getElementById("title").value = serverTask.title;
                document.getElementById("description").value = serverTask.description;
                document.getElementById("status").value = serverTask.status;
                document.getElementById("priority").value = serverTask.priority;
                document.getElementById("assigneeId").value = serverTask.assigneeId;
                document.getElementById("dueDate").value = serverTask.dueDate;
                showToast("Reset to saved values.");
            }
            function buildPutPayload() {
                const dueDateStr = document.getElementById("dueDate").value;

                return {
                    Title: document.getElementById("title").value,
                    Description: document.getElementById("description").value,
                    Status: document.getElementById("status").value,
                    Priority: parseInt(document.getElementById("priority").value, 10),
                    AssigneeId: document.getElementById("assigneeId").value,
                    ProjectId: serverTask.projectId,
                    DueDate: dueDateStr ? dueDateStr : null
                };
            }
            async function saveFullUpdate() {
              try {
                setSaving(true);

                const payload = buildPutPayload();
                const assignee = document.getElementById("assigneeId").value;

                if (!assignee) {
                  showToast("AssigneeId is required.", false);
                  return;
                }

                const res = await fetch(`?handler=SaveFullUpdate&id=${serverTask.id}&tab=overview`, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  credentials: "include",
                  body: JSON.stringify(payload)
                });

                if (!res.ok) {
                  const txt = await res.text();
                  showToast(`Save failed: ${res.status} ${txt}`, false);
                  return;
                }

                const data = await res.json();
                if (data?.redirectUrl) {
                  window.location.href = data.redirectUrl;
                  return;
                }

                showToast("Saved.");
              } catch (e) {
                showToast(`Save error: ${e}`, false);
              } finally {
                setSaving(false);
              }
            }


            async function saveStatus() {
                try {
                    const newStatus = document.getElementById("status").value;

                const res = await fetch(`?handler=UpdateStatus&id=${serverTask.id}&tab=overview`, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  credentials: "include",
                  body: JSON.stringify({ Status: newStatus })
                });
                    if (!res.ok) {
                        const txt = await res.text();
                        showToast(`Status update failed: ${res.status} ${txt}`, false);
                        return;
                    }

                    showToast("Status updated.");
                } catch (e) {
                    showToast(`Status error: ${e}`, false);
                }
            }
        </script>
    }

    @* ---------------- Comments ---------------- *@
    @if (Model.Tab == "comments")
    {
        <div class="card mb-3">
            <div class="card-header"><strong>Add Comment</strong></div>
            <div class="card-body">

                @if (!string.IsNullOrWhiteSpace(Model.CommentError))
                {
                    <div class="alert alert-danger" style="white-space:pre-wrap;">@Model.CommentError</div>
                }
                <form method="post" asp-page-handler="AddComment" asp-route-id="@Model.Id" asp-route-tab="comments">
                    <div class="mb-2">
                        <textarea class="form-control" rows="3"
                                  asp-for="AddCommentInput.Body"
                                  placeholder="Write a comment..."></textarea>
                        <span class="text-danger" asp-validation-for="AddCommentInput.Body"></span>
                    </div>

                    <button class="btn btn-primary" type="submit">Post</button>
                </form>
            </div>
        </div>

        <div class="card">
            <div class="card-header"><strong>Comments</strong></div>
            <div class="card-body">
                @if (Model.Comments.Count == 0)
                {
                    <div class="text-muted">No comments yet.</div>
                }
                else
                {
                    <div class="list-group">
                        @foreach (var c in Model.Comments.OrderByDescending(x => x.CreatedAt))
                        {
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between">
                                    <div class="text-muted small">
                                        by <code>@c.AuthorId</code>
                                    </div>
                                    <div class="text-muted small">
                                        @c.CreatedAt.ToString("yyyy-MM-dd HH:mm")
                                    </div>
                                </div>
                                <div class="mt-2">@c.Body</div>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    }

    @* ---------------- Activity ---------------- *@
    @if (Model.Tab == "activity")
    {
        <div class="card">
            <div class="card-header"><strong>Activity</strong></div>
            <div class="card-body">
                @if (Model.Activity?.Items == null || Model.Activity.Items.Count == 0)
                {
                    <div class="text-muted">No activity yet.</div>
                }
                else
                {
                    @foreach (var a in Model.Activity.Items)
                    {
                        <div class="border rounded p-2 mb-2">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <span class="badge bg-secondary">@a.ActionType</span>
                                    <span class="text-muted small">by <code>@a.ActorId</code></span>
                                </div>
                                <div class="text-muted small">@a.CreatedAt.ToString("yyyy-MM-dd HH:mm")</div>
                            </div>
                            <div class="mt-2">@a.Message</div>
                        </div>
                    }
                }
            </div>
        </div>
    }
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
