@page "{id:guid}"
@model DenoLite.Web.Pages.Tasks.DetailsModel
@using DenoLite.Domain.Enums

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <div class="text-muted small">
            <a href="/Projects">Projects</a> / Task
        </div>
        <h2 class="mb-0">@Model.Task?.Title</h2>
        <div class="text-muted">TaskId: <code>@Model.Id</code></div>
    </div>

    <div class="d-flex gap-2">
        @if (Model.Task != null)
        {
            <button class="btn btn-danger" onclick="deleteTask()">Delete Task</button>
            <a class="btn btn-outline-secondary" href="/Projects/Details/@Model.Task.ProjectId">Back to Project</a>
        }
    </div>
</div>

@if (!string.IsNullOrWhiteSpace(Model.Error))
{
    <div class="alert alert-danger" style="white-space:pre-wrap;">@Model.Error</div>
}

@* Global Toast for notifications (delete, etc.) *@
<div id="toast" class="alert d-none mb-3" role="alert"></div>

<script>
    // Base serverTask object used across Overview + Delete scripts
    const serverTask = {
        id: "@Model.Id",
        projectId: "@Model.Task?.ProjectId",
        title: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Task?.Title ?? ""))
    };

    // Members of this task's project for mention suggestions (handle = email local-part)
    window.denoLiteTaskMentionMembers = @Html.Raw(
        System.Text.Json.JsonSerializer.Serialize(
            Model.AssigneeEmailById
                .Where(kvp => !string.IsNullOrWhiteSpace(kvp.Value))
                .Select(kvp => new {
                    id = kvp.Key,
                    email = kvp.Value!,
                    handle = kvp.Value!.Contains("@")
                        ? kvp.Value!.Substring(0, kvp.Value!.IndexOf("@"))
                        : kvp.Value!
                })
        )
    );
</script>

@if (string.IsNullOrWhiteSpace(Model.Error))
{
    <ul class="nav nav-tabs mb-3">
        <li class="nav-item">
            <a class="nav-link @(Model.Tab == "overview" ? "active" : "")"
               href="/Tasks/Details/@Model.Id?tab=overview">Overview</a>
        </li>
        <li class="nav-item">
            <a class="nav-link @(Model.Tab == "comments" ? "active" : "")"
               href="/Tasks/Details/@Model.Id?tab=comments">Comments</a>
        </li>
        <li class="nav-item">
            <a class="nav-link @(Model.Tab == "activity" ? "active" : "")"
               href="/Tasks/Details/@Model.Id?tab=activity">Activity</a>
        </li>
    </ul>

    @* ---------------- Overview ---------------- *@
    @if (Model.Tab == "overview")
    {
        <div class="card">
            <div class="card-body">

                <div class="d-flex justify-content-between align-items-start gap-3 flex-wrap">
                    <div class="flex-grow-1">
                        <label class="text-muted small mb-1">Title</label>
                        <input id="title" class="form-control" value="@Model.Task?.Title" />
                    </div>
                </div>

                <div class="mt-3">
                    <label class="text-muted small mb-1">Description</label>
                    <div id="taskDetailsDescriptionEditor" class="border rounded bg-white" style="min-height: 140px;"></div>
                    <div id="taskDetailsDescriptionFallbackWrap" class="d-none">
                        <div class="btn-toolbar mb-1 border rounded p-1 bg-light" role="toolbar">
                            <button type="button" class="btn btn-sm btn-outline-secondary" title="Bold" data-cmd="bold">B</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" title="Italic" data-cmd="italic">I</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" title="Underline" data-cmd="underline">U</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" title="Bullet list" data-cmd="insertUnorderedList">•</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" title="Numbered list" data-cmd="insertOrderedList">1.</button>
                        </div>
                        <div id="taskDetailsDescriptionFallback" class="form-control border rounded" contenteditable="true" style="min-height: 120px; max-height: 200px; overflow-y: auto;" data-placeholder="Describe the task…"></div>
                    </div>
                </div>
                        <div class="form-text">Auto-saves on change</div>

                <hr />

                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="text-muted small mb-1">Status</label>
                        <select id="status" class="form-select">
                            @foreach (var s in Enum.GetValues<DenoTaskStatus>())
                            {
                                <option value="@s" selected="@(Model.Task?.Status == s)">@s</option>
                            }
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label class="text-muted small mb-1">Priority</label>
                        <select id="priority" class="form-select">
                            @for (var p = 1; p <= 5; p++)
                            {
                                var label = p switch
                                {
                                    1 => "High",
                                    2 => "Medium-High",
                                    3 => "Medium",
                                    4 => "Medium-Low",
                                    5 => "Low",
                                    _ => ""
                                };

                                <option value="@p" selected="@(Model.Task?.Priority == p)">
                                    @p (@label)
                                </option>
                            }
                        </select>

                    </div>

                    <div class="col-md-4">
                        <label class="text-muted small mb-1">Due Date</label>
                        <input id="dueDate" type="date" class="form-control"
                               value="@(Model.Task?.DueDate?.ToString("yyyy-MM-dd") ?? "")" />
                        <div class="form-text">Sends yyyy-MM-dd (safe for Postgres)</div>
                    </div>
                </div>

                <div class="row g-3 mt-1">
                    <div class="col-md-6">
                        <label class="text-muted small mb-1">Assignee</label>
                        <select id="assigneeId"
                                class="form-select"
                                asp-for="Task.AssigneeId"
                                asp-items="Model.AssigneeSelectItems">
                        </select>
                    </div>

                    <div class="col-md-6 d-flex align-items-end justify-content-end gap-2">
                        <button id="btnSaveAll" class="btn btn-primary" type="button" onclick="saveFullUpdate()">
                            Save changes
                        </button>
                        <button class="btn btn-outline-secondary" type="button" onclick="resetToServerValues()">
                            Reset
                        </button>
                    </div>
                </div>

                <hr />

                <div class="small text-muted">
                    ProjectId: <code>@Model.Task?.ProjectId</code>
                </div>
            </div>
        </div>

        <script>
            // Extend serverTask with full details for overview tab
            serverTask.description = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Task?.Description ?? ""));
            serverTask.status = "@Model.Task?.Status";
            serverTask.priority = "@(Model.Task?.Priority ?? 3)";
            serverTask.assigneeId = "@Model.Task?.AssigneeId";
            serverTask.dueDate = "@(Model.Task?.DueDate?.ToString("yyyy-MM-dd") ?? "")";

            function setSaving(isSaving) {
              const btn = document.getElementById("btnSaveAll");
              if (btn) btn.disabled = isSaving;
            }

            function resetToServerValues() {
                document.getElementById("title").value = serverTask.title;
                if (window.taskDetailsQuill) {
                    try { window.taskDetailsQuill.root.innerHTML = serverTask.description || ""; } catch (_) { window.taskDetailsQuill.setText(serverTask.description || ""); }
                }
                var fallbackEd = document.getElementById("taskDetailsDescriptionFallback");
                if (fallbackEd) fallbackEd.innerHTML = serverTask.description || "";
                document.getElementById("status").value = serverTask.status;
                document.getElementById("priority").value = serverTask.priority;
                document.getElementById("assigneeId").value = serverTask.assigneeId;
                document.getElementById("dueDate").value = serverTask.dueDate;
                showToast("Reset to saved values.");
            }
            function buildPutPayload() {
                const dueDateStr = document.getElementById("dueDate").value;
                var descEl = document.getElementById("taskDetailsDescriptionFallback");
                const description = window.taskDetailsQuill ? window.taskDetailsQuill.root.innerHTML : (descEl ? descEl.innerHTML : "");

                return {
                    Title: document.getElementById("title").value,
                    Description: description,
                    Status: document.getElementById("status").value,
                    Priority: parseInt(document.getElementById("priority").value, 10),
                    AssigneeId: document.getElementById("assigneeId").value,
                    ProjectId: serverTask.projectId,
                    DueDate: dueDateStr ? dueDateStr : null
                };
            }
            async function saveFullUpdate() {
              try {
                setSaving(true);

                const payload = buildPutPayload();
                const assignee = document.getElementById("assigneeId").value;

                if (!assignee) {
                  showToast("AssigneeId is required.", false);
                  return;
                }

                const res = await fetch(`?handler=SaveFullUpdate&id=${serverTask.id}&tab=overview`, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  credentials: "include",
                  body: JSON.stringify(payload)
                });

                if (!res.ok) {
                  const txt = await res.text();
                  showToast(`Save failed: ${res.status} ${txt}`, false);
                  return;
                }

                const data = await res.json();


            async function saveStatus() {
                try {
                    const newStatus = document.getElementById("status").value;

                const res = await fetch(`?handler=UpdateStatus&id=${serverTask.id}&tab=overview`, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  credentials: "include",
                  body: JSON.stringify({ Status: newStatus })
                });
                    if (!res.ok) {
                        const txt = await res.text();
                        showToast(`Status update failed: ${res.status} ${txt}`, false);
                        return;
                    }

                    showToast("Status updated.");
                } catch (e) {
                    showToast(`Status error: ${e}`, false);
                }
            }
                if (data?.redirectUrl) {
                  window.location.href = data.redirectUrl;
                  return;
                }

                showToast("Saved.");
              } catch (e) {
                showToast(`Save error: ${e}`, false);
              } finally {
                setSaving(false);
              }
            }
        </script>
    }

    @* ---------------- Comments ---------------- *@
    @if (Model.Tab == "comments")
    {
        <div class="card mb-3">
            <div class="card-header"><strong>Add Comment</strong></div>
            <div class="card-body">

                @if (!string.IsNullOrWhiteSpace(Model.CommentError))
                {
                    <div class="alert alert-danger" style="white-space:pre-wrap;">@Model.CommentError</div>
                }
                <form method="post" asp-page-handler="AddComment" asp-route-id="@Model.Id" asp-route-tab="comments" id="addCommentForm">
                    <div class="mb-2">
                        <textarea class="form-control" rows="3" maxlength="400"
                                  asp-for="AddCommentInput.Body"
                                  placeholder="Write a comment..."
                                  id="addCommentBody"></textarea>
                        <div id="addCommentEditor" class="border rounded bg-white" style="min-height: 100px; max-height: 220px; overflow-y: auto;"></div>
                        <span class="text-danger" asp-validation-for="AddCommentInput.Body"></span>
                    </div>

                    <button class="btn btn-primary" type="submit">Post</button>
                </form>
            </div>
        </div>

        <div class="card">
            <div class="card-header"><strong>Comments</strong></div>
            <div class="card-body">
                @if (Model.Comments.Count == 0)
                {
                    <div class="text-muted">No comments yet.</div>
                }
                else
                {
                    <div class="list-group">
                        @foreach (var c in Model.Comments.OrderByDescending(x => x.CreatedAt))
                        {
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between">
                                    <div class="text-muted small">
                                        by <code>@(string.IsNullOrEmpty(c.AuthorEmail) ? c.AuthorId.ToString() : c.AuthorEmail)</code>
                                    </div>
                                    <div class="text-muted small">
                                        @c.CreatedAt.ToString("yyyy-MM-dd HH:mm")
                                    </div>
                                </div>
                                <div class="mt-2">@Html.Raw(c.Body)</div>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    }

    @* ---------------- Activity ---------------- *@
    @if (Model.Tab == "activity")
    {
        <div class="card">
            <div class="card-header"><strong>Activity</strong></div>
            <div class="card-body">
                @if (Model.Activity?.Items == null || Model.Activity.Items.Count == 0)
                {
                    <div class="text-muted">No activity yet.</div>
                }
                else
                {
                    @foreach (var a in Model.Activity.Items)
                    {
                        <div class="border rounded p-2 mb-2">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <span class="badge bg-secondary">@a.ActionType</span>
                                    <span class="text-muted small">by <code>@(Model.AssigneeEmailById.TryGetValue(a.ActorId, out var actorEmail) && !string.IsNullOrWhiteSpace(actorEmail) ? actorEmail : a.ActorId.ToString())</code></span>
                                </div>
                                <div class="text-muted small">@a.CreatedAt.ToString("yyyy-MM-dd HH:mm")</div>
                            </div>
                            <div class="mt-2">@Model.CleanActivityMessage(a.Message, a.ActionType)</div>
                        </div>
                    }
                }
            </div>
        </div>
    }
}

<script>
    // Global toast notification function
    function showToast(message, ok = true) {
        const el = document.getElementById("toast");
        if (!el) return;
        el.classList.remove("d-none", "alert-success", "alert-danger");
        el.classList.add(ok ? "alert-success" : "alert-danger");
        el.innerText = message;
        setTimeout(() => el.classList.add("d-none"), 3000);
    }

    async function deleteTask() {
        if (!confirm(`Are you sure you want to delete "${serverTask.title}"? This will move it to the recycle bin.`)) {
            return;
        }

        try {
            const res = await fetch(`?handler=DeleteTask&id=${serverTask.id}`, {
                method: "POST",
                credentials: "include"
            });

            if (!res.ok) {
                const txt = await res.text();
                showToast(`Delete failed: ${res.status} ${txt}`, false);
                return;
            }

            showToast("Task deleted. Redirecting...");
            setTimeout(() => {
                window.location.href = `/Projects/Details/${serverTask.projectId}`;
            }, 1000);
        } catch (e) {
            showToast(`Delete error: ${e}`, false);
        }
    }
</script>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <link href="https://cdn.jsdelivr.net/npm/quill@2/dist/quill.snow.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/quill@2/dist/quill.js"></script>
    <script>
        (function () {
            function initMentionSupport(quill, members, editorElement) {
                if (!quill || !editorElement || !Array.isArray(members) || members.length === 0) return;

                const container = editorElement.parentElement || editorElement;
                if (!container) return;
                if (!container.style.position) {
                    container.style.position = "relative";
                }

                const menu = document.createElement("div");
                menu.className = "mention-suggestions list-group position-absolute bg-white border rounded shadow-sm";
                menu.style.zIndex = "2000";
                menu.style.display = "none";
                menu.style.minWidth = "180px";
                container.appendChild(menu);

                let mentionStartIndex = null;

                function closeMenu() {
                    menu.style.display = "none";
                    menu.innerHTML = "";
                    mentionStartIndex = null;
                }

                function openMenu(bounds) {
                    menu.innerHTML = "";
                    members.forEach(m => {
                        const item = document.createElement("button");
                        item.type = "button";
                        item.className = "list-group-item list-group-item-action py-1 px-2";
                        const handleText = (m.handle || "");
                        item.textContent = handleText;
                        item.addEventListener("click", (ev) => {
                            ev.preventDefault();
                            ev.stopPropagation();
                            applyMention(m.handle);
                        });
                        menu.appendChild(item);
                    });

                    menu.style.left = (bounds.left || 0) + "px";
                    menu.style.top = ((bounds.bottom || bounds.top || 0) + 4) + "px";
                    menu.style.display = "block";
                }

                function applyMention(handle) {
                    if (!handle) {
                        closeMenu();
                        return;
                    }
                    const sel = quill.getSelection(true);
                    if (!sel) {
                        closeMenu();
                        return;
                    }
                    let index = sel.index;
                    if (index > 0) {
                        const prev = quill.getText(index - 1, 1);
                        const prevCode = prev && prev.length ? prev.charCodeAt(0) : 0;
                        if (prevCode === 64) {
                            quill.deleteText(index - 1, 1, "user");
                            index = index - 1;
                        }
                    }
                    const atSign = String.fromCharCode(64);
                    quill.insertText(index, atSign + handle, { bold: true }, "user");
                    quill.insertText(index + handle.length + 1, " ", "user");
                    quill.setSelection(index + handle.length + 2, 0, "user");
                    closeMenu();
                }

                quill.on("text-change", function (_, __, source) {
                    if (source !== "user") return;
                    const sel = quill.getSelection();
                    if (!sel) {
                        closeMenu();
                        return;
                    }
                    const index = sel.index;
                    if (index <= 0) {
                        closeMenu();
                        return;
                    }

                    const ch = quill.getText(index - 1, 1);
                    const code = ch && ch.length ? ch.charCodeAt(0) : 0;
                    if (code !== 64) {
                        // If user moved away, just close any open menu
                        if (menu.style.display !== "none") {
                            closeMenu();
                        }
                        return;
                    }

                    mentionStartIndex = index - 1;
                    const bounds = quill.getBounds(index);
                    openMenu(bounds);
                });

                quill.root.addEventListener("blur", () => {
                    // Delay slightly so click on menu can register
                    setTimeout(closeMenu, 150);
                });
            }

            const editorEl = document.getElementById("taskDetailsDescriptionEditor");
            const fallbackWrap = document.getElementById("taskDetailsDescriptionFallbackWrap");
            const fallbackEd = document.getElementById("taskDetailsDescriptionFallback");
            const initialDescription = typeof serverTask !== "undefined" ? (serverTask.description || "") : "";

            function useTaskDetailsFallback() {
                if (!editorEl) return;
                editorEl.classList.add("d-none");
                if (fallbackWrap) fallbackWrap.classList.remove("d-none");
                if (fallbackEd) {
                    fallbackEd.innerHTML = initialDescription;
                    fallbackEd.setAttribute("data-placeholder", "Describe the task…");
                }
            }

            function updateTaskDetailsToolbarState() {
                if (!fallbackWrap || !fallbackEd) return;
                var cmdList = ["bold", "italic", "underline", "insertUnorderedList", "insertOrderedList"];
                cmdList.forEach(function (cmd) {
                    var btn = fallbackWrap.querySelector('[data-cmd="' + cmd + '"]');
                    if (!btn) return;
                    var active = false;
                    try { active = document.queryCommandState(cmd); } catch (e) { active = false; }
                    if (active) {
                        btn.classList.add("btn-secondary", "text-white");
                        btn.classList.remove("btn-outline-secondary");
                    } else {
                        btn.classList.remove("btn-secondary", "text-white");
                        btn.classList.add("btn-outline-secondary");
                    }
                });
            }

            function initTaskDetailsFallbackToolbar() {
                if (!fallbackEd) return;
                fallbackWrap.querySelectorAll("[data-cmd]").forEach(function (btn) {
                    btn.addEventListener("click", function () {
                        fallbackEd.focus();
                        document.execCommand(btn.getAttribute("data-cmd"), false, null);
                        fallbackEd.dispatchEvent(new Event("input", { bubbles: true }));
                        updateTaskDetailsToolbarState();
                    });
                });
                fallbackEd.addEventListener("keyup", updateTaskDetailsToolbarState);
                fallbackEd.addEventListener("mouseup", updateTaskDetailsToolbarState);
                updateTaskDetailsToolbarState();
            }

            if (editorEl && typeof Quill !== "undefined") {
                try {
                    window.taskDetailsQuill = new Quill(editorEl, {
                        theme: "snow",
                        placeholder: "Describe the task…",
                        modules: {
                            toolbar: [
                                ["bold", "italic", "underline", "strike"],
                                [{ list: "ordered" }, { list: "bullet" }],
                                ["link"],
                                ["clean"]
                            ]
                        }
                    });
                    try {
                        window.taskDetailsQuill.root.innerHTML = initialDescription;
                    } catch (_) {
                        window.taskDetailsQuill.setText(initialDescription);
                    }
                    if (fallbackWrap) fallbackWrap.classList.add("d-none");

                    // Enable mention suggestions based on project members
                    if (window.denoLiteTaskMentionMembers) {
                        initMentionSupport(window.taskDetailsQuill, window.denoLiteTaskMentionMembers, editorEl);
                    }
                } catch (e) {
                    useTaskDetailsFallback();
                    initTaskDetailsFallbackToolbar();
                }
            } else {
                if (!editorEl || typeof Quill === "undefined") {
                    useTaskDetailsFallback();
                    initTaskDetailsFallbackToolbar();
                }
            }

            // -------------------- Comments Quill (with mentions) --------------------
            (function initCommentsQuill() {
                const bodyTextarea = document.getElementById("addCommentBody");
                const editor = document.getElementById("addCommentEditor");
                const form = document.getElementById("addCommentForm");
                if (!bodyTextarea || !editor || !form) return;
                if (typeof Quill === "undefined") return;

                try {
                    const commentQuill = new Quill(editor, {
                        theme: "snow",
                        placeholder: "Write a comment…",
                        modules: {
                            toolbar: [
                                ["bold", "italic", "underline", "strike"],
                                [{ list: "ordered" }, { list: "bullet" }],
                                ["link"],
                                ["clean"]
                            ]
                        }
                    });

                    if (bodyTextarea.value) {
                        try {
                            commentQuill.root.innerHTML = bodyTextarea.value;
                        } catch (_) {
                            commentQuill.setText(bodyTextarea.value);
                        }
                    }

                    bodyTextarea.classList.add("d-none");

                    if (window.denoLiteTaskMentionMembers) {
                        initMentionSupport(commentQuill, window.denoLiteTaskMentionMembers, editor);
                    }

                    form.addEventListener("submit", function () {
                        bodyTextarea.value = commentQuill.root.innerHTML;
                    });
                } catch {
                    // If Quill fails for comments, fall back to plain textarea
                }
            })();
        })();
    </script>
}
